<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tablero de Tickets</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27%3E%3Ctext y=%2750%27 font-size=%2750%27%3E游꿞%3C/text%3E%3C/svg%3E" />

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root{--bg-1:#030712;--bg-2:#0b1220;--surface:rgba(15,23,42,.58);--stroke:rgba(148,163,184,.24);--text:#e2e8f0;--muted:#94a3b8;--accent:#7c3aed;--accent-2:#06b6d4;--danger:#dc2626;--ok:#16a34a}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);background:radial-gradient(1000px 500px at 10% -10%,rgba(124,58,237,.3),transparent 55%),radial-gradient(900px 500px at 100% -20%,rgba(6,182,212,.25),transparent 60%),linear-gradient(180deg,var(--bg-2),var(--bg-1));min-height:100vh;padding:clamp(12px,2.4vw,26px)}
    .container{max-width:1400px;margin:auto}
    .card{background:var(--surface);backdrop-filter:blur(14px);border:1px solid var(--stroke);border-radius:16px;padding:clamp(12px,1.6vw,16px);margin-bottom:12px;box-shadow:0 10px 40px rgba(0,0,0,.28);animation:fadeIn .35s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    button,.btn{border:none;color:#fff;padding:10px 14px;font-size:14px;border-radius:10px;cursor:pointer;background:linear-gradient(135deg,var(--accent),#4338ca);transition:transform .18s ease, box-shadow .2s ease, opacity .2s ease;box-shadow:0 6px 18px rgba(124,58,237,.35)}
    button:hover,.btn:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(124,58,237,.35)}
    button.secondary{background:#1e293b;box-shadow:none}
    button.danger{background:linear-gradient(135deg,#ef4444,var(--danger));box-shadow:0 6px 16px rgba(220,38,38,.4)}
    button.ghost{background:rgba(30,41,59,.4);border:1px solid rgba(148,163,184,.25);box-shadow:none}
    button:disabled{opacity:.45;cursor:not-allowed;transform:none}
    label{font-size:12px;color:#cbd5e1;display:block;margin:0 0 6px}
    input,select,textarea{width:100%;padding:11px 12px;font-size:14px;border-radius:11px;border:1px solid rgba(148,163,184,.24);background:rgba(2,6,23,.6);color:var(--text);margin-bottom:10px;outline:none;transition:border-color .2s ease, box-shadow .2s ease}
    input:focus,select:focus,textarea:focus{border-color:var(--accent-2);box-shadow:0 0 0 3px rgba(6,182,212,.2)}
    textarea{min-height:86px;resize:vertical}
    .small{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap}.row>*{flex:1 1 220px}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:980px){.grid{grid-template-columns:1.2fr .9fr}}
    .badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--stroke)}
    .badge.ok{color:#86efac;border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12)}
    .badge.off{color:#fca5a5;border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12)}
    .searchWrap{position:relative}.searchWrap input{padding-left:36px;margin:0}.searchWrap:before{content:'游댍';position:absolute;left:11px;top:8px;opacity:.65}
    .kpiGrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .kpiGrid.singleRow{grid-template-columns:repeat(5,minmax(0,1fr))!important}
    @media (max-width:900px){.kpiGrid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .kpi{padding:12px;border:1px solid var(--stroke);border-radius:14px;background:rgba(2,6,23,.35)}
    .kpi .label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px}
    .kpi .value{font-size:22px;margin-top:4px}
    .feedItem{padding:10px;border:1px solid rgba(148,163,184,.14);border-radius:12px;background:rgba(2,6,23,.25);margin-bottom:8px}
    .feedTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .feedType{font-weight:600}
    .feedMeta{font-size:12px;color:var(--muted);margin-top:4px}

    .boardWrap{overflow-x:auto;overflow-y:visible;padding-bottom:4px}
    .board{display:grid;grid-template-columns:repeat(5,minmax(260px,1fr));gap:12px;overflow:visible;align-items:start}
    .column{background:rgba(2,6,23,.35);border:1px solid var(--stroke);border-radius:12px;padding:10px;min-height:220px}
    .column h4{margin:4px 0 10px;font-size:14px;text-transform:uppercase;color:#cbd5e1;letter-spacing:.3px}
    .ticket{background:rgba(15,23,42,.8);border:1px solid rgba(148,163,184,.2);border-radius:10px;padding:10px;margin-bottom:8px}
    .ticket h5{margin:0 0 8px;font-size:14px}
    .ticket p{margin:0 0 8px;font-size:13px;color:#cbd5e1}
    .ticket .meta{font-size:11px;color:var(--muted)}
    .modalBack{position:fixed;inset:0;background:rgba(2,6,23,.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:16px;z-index:99}
    .modal{width:min(760px,100%);max-height:90vh;overflow:auto}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <div class="container" id="app"></div>

  <div id="ticketModal" class="modalBack hidden">
    <div class="card modal">
      <div class="inline" style="justify-content:space-between;margin-bottom:8px">
        <h3 style="margin:0">Nuevo ticket</h3>
        <button class="secondary" onclick="closeTicketModal()">Cerrar</button>
      </div>

      <div class="row">
        <div><label>T칤tulo</label><input id="tTitle" /></div>
        <div><label>Prioridad</label><select id="tPriority"><option value="Baja">Baja</option><option value="Media">Media</option><option value="Alta">Alta</option></select></div>
      </div>
      <div><label>Detalle</label><textarea id="tDescription"></textarea></div>
      <div><label>Cliente/츼rea</label><input id="tClient" /></div>

      <div class="inline" style="justify-content:flex-end">
        <button onclick="saveTicket()">Crear ticket</button>
        <button class="secondary" onclick="closeTicketModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="ticketDetailModal" class="modalBack hidden">
    <div class="card modal">
      <div class="inline" style="justify-content:space-between;margin-bottom:8px">
        <h3 style="margin:0">Detalle de ticket</h3>
        <button class="secondary" onclick="closeTicketDetailModal()">Cerrar</button>
      </div>
      <div id="ticketDetailContent"></div>
    </div>
  </div>

  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyA4-yTeI0CemnlROxF9hIgj_HxiDLvYZTY",
      authDomain: "tablero-a0658.firebaseapp.com",
      databaseURL: "https://tablero-a0658-default-rtdb.firebaseio.com",
      projectId: "tablero-a0658",
      storageBucket: "tablero-a0658.firebasestorage.app",
      messagingSenderId: "1018762078941",
      appId: "1:1018762078941:web:785861e9f2ddb843b88934"
    })

    const db = firebase.database()
    const DEFAULT_USERS = [
      { email: "admin@tablero.local", password: "1234", role: "admin" },
      { email: "consultor@tablero.local", password: "1234", role: "consultor" },
      { email: "analista@tablero.local", password: "1234", role: "analista" }
    ]

    let currentUser = null
    let currentRole = null
    let ticketSearchTerm = ""

    const STATUS = {
      unassigned: "Pendientes de asignar",
      todo: "Por hacer",
      doing: "En curso",
      recurrent: "Recurrente",
      done: "Finalizadas"
    }

    const SHEET_ID = "1tNNtG2Asr1ds1_-3P6PmVgsHbdlhhfrV7GhWJDiTO1Q"
    const SHEET_GID = "0"
    // Reemplazar por tu URL de Web App de Apps Script para habilitar escritura en la hoja.
    // Debe aceptar JSON { action, payload } para createTicket/updateTicket/deleteTicket.
    const SHEET_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbyRLv3IqWF7O-045AsuEQzqOn2FstgF8X3TfBXQB6eSLJr44u6nm3QUQH_mtBaSjVYUhw/exec"
    let cachedTickets = []

    function emailKey(email){ return (email||"").toLowerCase().replace(/[.#$/\[\]]/g, "_") }
    function htmlEscape(v){ return String(v??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;") }
    function generateId(){ return (crypto?.randomUUID?.() || `tk_${Date.now()}_${Math.random().toString(36).slice(2,8)}`) }
    function parseGvizJson(text){
      const raw = text.replace(/^\/\/O_o\s*\n/, "")
      const start = raw.indexOf("{")
      const end = raw.lastIndexOf("}")
      return JSON.parse(raw.slice(start, end + 1))
    }

    async function fetchTicketsFromSheet(){
      const query = encodeURIComponent("select A,B,C,D,E,F,G,H,I,J,K,L")
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${SHEET_GID}&tq=${query}`
      const res = await fetch(url)
      if(!res.ok) throw new Error("No se pudo leer la planilla")
      const gviz = parseGvizJson(await res.text())
      const rows = gviz?.table?.rows || []

      return rows
        .map(r => (r.c || []).map(c => c?.v ?? ""))
        .filter(cols => (cols[0]||"").toString().trim())
        .map(cols => ({
          id: String(cols[0]||""),
          title: String(cols[1]||""),
          description: String(cols[2]||""),
          priority: String(cols[3]||"Media"),
          client: String(cols[4]||""),
          status: String(cols[5]||"unassigned"),
          assignedTo: String(cols[6]||""),
          comments: (() => { try{ return JSON.parse(cols[7]||"{}") }catch(_){ return {} } })(),
          createdAt: String(cols[8]||""),
          createdBy: String(cols[9]||""),
          updatedAt: String(cols[10]||""),
          updatedBy: String(cols[11]||"")
        }))
    }

    async function sheetWrite(action, payload){
      if(!SHEET_WEBHOOK_URL){
        alert("Falta configurar SHEET_WEBHOOK_URL para guardar cambios en Google Sheets")
        throw new Error("SHEET_WEBHOOK_URL no configurada")
      }

      // Enviamos text/plain para evitar preflight CORS en hosting est치tico (GitHub Pages).
      const requestBody = JSON.stringify({ action, payload, sheetId: SHEET_ID, gid: SHEET_GID })
      const res = await fetch(SHEET_WEBHOOK_URL, {
        method: "POST",
        mode: "cors",
        redirect: "follow",
        body: requestBody
      })

      if(!res.ok) throw new Error(`No se pudo escribir en Google Sheets (${res.status})`)
      const data = await res.json().catch(() => ({ ok: true }))
      if(data && data.ok === false) throw new Error(data.error || "Error al guardar en Google Sheets")
      return data
    }

    async function logActivity(eventType, details={}){
      try{
        await db.ref("activity_logs").push({
          eventType,
          email: currentUser?.email || "sin-usuario",
          role: currentRole || "sin-rol",
          timestampIso: new Date().toISOString(),
          ...details
        })
      }catch(_){ }
    }

    async function ensureDefaultUsers(){
      for(const user of DEFAULT_USERS){
        const ref = db.ref("users_by_email").child(emailKey(user.email))
        const snap = await ref.once("value")
        if(!snap.exists()){
          await ref.set({
            email: user.email,
            password: user.password,
            role: user.role,
            active: true,
            createdAt: new Date().toISOString(),
            createdBy: "system"
          })
        }
      }
    }

    async function getUserFromDb(email){
      const snap = await db.ref("users_by_email").child(emailKey(email)).once("value")
      return snap.val()
    }

    function renderLogin(){
      document.getElementById("app").innerHTML = `
        <div class="card" style="max-width:480px;margin:40px auto">
          <h2 style="margin-top:0">Tablero de tickets</h2>
          <p class="small">Acceso por Email + Contrase침a.</p>
          <label>Email</label><input id="loginEmail" type="email">
          <label>Contrase침a</label><input id="loginPassword" type="password">
          <button onclick="handleLogin()" style="width:100%">Entrar</button>
          <p class="small" style="margin-top:10px">Usuarios iniciales: admin@tablero.local, consultor@tablero.local, analista@tablero.local (clave: 1234)</p>
        </div>`
    }

    async function handleLogin(){
      const email = document.getElementById("loginEmail").value.trim().toLowerCase()
      const password = document.getElementById("loginPassword").value
      if(!email || !password) return alert("Complet치 email y contrase침a")

      const user = await getUserFromDb(email)
      if(!user || !user.active) return alert("Usuario inexistente o inactivo")
      if(user.password !== password) return alert("Contrase침a incorrecta")

      currentUser = { email: user.email }
      currentRole = user.role

      await db.ref("users_by_email").child(emailKey(email)).update({ lastAccessAt: new Date().toISOString() })
      logActivity("login", { userAgent: navigator.userAgent })
      renderApp()
    }

    function logout(){ currentUser = null; currentRole = null; renderLogin() }

    function renderApp(){
      const isAdmin = currentRole === "admin"
      const canCreateTicket = currentRole === "admin" || currentRole === "analista" || currentRole === "consultor"

      document.getElementById("app").innerHTML = `
        <div class="grid">
          <div class="card">
            <div class="inline" style="justify-content:space-between">
              <div>
                <h2 style="margin:0">Tablero de tickets</h2>
                <p class="small" style="margin:6px 0 0">Panel ${htmlEscape(currentRole)} 췅 ${htmlEscape(currentUser.email)}</p>
              </div>
              <div class="inline">
                ${canCreateTicket?`<button onclick="openTicketModal()">+ Nuevo ticket</button>`:""}
                <button class="secondary" onclick="logout()">Cerrar sesi칩n</button>
              </div>
            </div>

            <div style="margin-top:14px">
              <h3 style="margin:0 0 10px">Dashboard</h3>
              <div class="kpiGrid ${currentRole === "consultor" ? "singleRow" : ""}">
                <div class="kpi"><div class="label">Tickets totales</div><div class="value" id="kpiTotal">-</div></div>
                <div class="kpi"><div class="label">Pendientes de asignar</div><div class="value" id="kpiUnassigned">-</div></div>
                <div class="kpi"><div class="label">En curso</div><div class="value" id="kpiDoing">-</div></div>
                <div class="kpi"><div class="label">Finalizadas</div><div class="value" id="kpiDone">-</div></div>
                <div class="kpi"><div class="label">Analistas</div><div class="value" id="kpiOperators">-</div></div>
                ${currentRole !== "consultor" ? `<div class="kpi"><div class="label">칔ltimo acceso analista</div><div class="value" style="font-size:14px;margin-top:8px" id="kpiLastAccess">-</div></div>` : ""}
              </div>
              ${currentRole !== "consultor" ? `
              <div style="margin-top:14px">
                <div class="inline" style="justify-content:space-between;align-items:center">
                  <h3 style="margin:0">Actividad reciente</h3>
                  <button class="ghost" onclick="loadDashboard()">Actualizar</button>
                </div>
                <div id="recentActivity" style="margin-top:10px"></div>
              </div>
              ` : ``}
            </div>
          </div>

          ${isAdmin?`
            <div class="card">
              <h3 style="margin-top:0">Gesti칩n de usuarios</h3>
              <div class="row">
                <div><label>Email</label><input id="uEmail"></div>
                <div><label>Contrase침a</label><input id="uPassword" type="text"></div>
              </div>
              <div class="row">
                <div><label>Rol</label><select id="uRole"><option value="consultor">Consultor</option><option value="analista">Analista</option><option value="admin">Admin</option></select></div>
                <div style="display:flex;align-items:flex-end"><button onclick="saveUserAccess()">Guardar usuario</button></div>
              </div>
              <div id="usersList" class="small"></div>
            </div>
          `:"<div></div>"}
        </div>

        <div class="card">
          <div class="inline" style="justify-content:space-between;margin-bottom:10px">
            <h3 style="margin:0">Tickets</h3>
            <span class="small">Vista Kanban de operaci칩n</span>
          </div>
          <div class="searchWrap"><input oninput="updateTicketSearch(this.value)" placeholder="Buscar por t칤tulo, cliente o descripci칩n"></div>
        </div>

        <div class="card"><div class="boardWrap"><div id="boardContainer"></div></div></div>
      `

      if(isAdmin) loadUsersAdmin()
      loadTickets()
      loadDashboard()
    }

    function updateTicketSearch(value){ ticketSearchTerm = (value||"").trim().toLowerCase(); loadTickets() }

    function openTicketModal(){ document.getElementById("ticketModal").classList.remove("hidden") }
    function closeTicketModal(){
      document.getElementById("tTitle").value = ""
      document.getElementById("tDescription").value = ""
      document.getElementById("tPriority").value = "Media"
      document.getElementById("tClient").value = ""
      document.getElementById("ticketModal").classList.add("hidden")
    }

    async function saveTicket(){
      const title = document.getElementById("tTitle").value.trim()
      const description = document.getElementById("tDescription").value.trim()
      const priority = document.getElementById("tPriority").value
      const client = document.getElementById("tClient").value.trim()

      if(!title || !description || !client) return alert("Complet치 t칤tulo, detalle y cliente/치rea")

      const now = new Date().toISOString()
      const ticket = {
        id: generateId(),
        title, description, priority, client,
        status: "unassigned",
        assignedTo: "",
        comments: {},
        createdAt: now,
        createdBy: currentUser.email,
        updatedAt: now,
        updatedBy: currentUser.email
      }

      await sheetWrite("createTicket", ticket)
      logActivity("ticket_creado", { title, client })
      closeTicketModal()
      await loadTickets()
      await loadDashboard()
    }

    async function loadTickets(){
      const container = document.getElementById("boardContainer")
      if(!container) return

      let data = []
      try{
        data = await fetchTicketsFromSheet()
      }catch(err){
        console.error(err)
        container.innerHTML = `<p class="small">No se pudieron cargar tickets desde Google Sheets.</p>`
        return
      }
      cachedTickets = data
      const grouped = { unassigned: [], todo: [], doing: [], recurrent: [], done: [] }

      Object.entries(data).forEach(([_, t]) => {
        const canSeeTicket = currentRole === "admin" || currentRole === "analista" || (currentRole === "consultor" && (t.createdBy||"") === currentUser.email)
        if(!canSeeTicket) return

        const haystack = `${t.title||""} ${t.description||""} ${t.client||""}`.toLowerCase()
        if(ticketSearchTerm && !haystack.includes(ticketSearchTerm)) return

        const status = grouped[t.status] ? t.status : "unassigned"
        grouped[status].push(t)
      })

      container.innerHTML = `<div class="board">${Object.entries(STATUS).map(([status, label]) => `
        <div class="column">
          <h4>${label} <span class="small">(${grouped[status].length})</span></h4>
          ${grouped[status].map(t => renderTicketCard(t, status)).join("") || `<p class="small">Sin tickets</p>`}
        </div>
      `).join("")}</div>`
    }

    function renderTicketCard(ticket, status){
      if(currentRole === "consultor"){
        return `
          <div class="ticket">
            <h5>${htmlEscape(ticket.title||"-")}</h5>
            <div class="meta">Asignado a: ${htmlEscape(ticket.assignedTo||"Sin asignar")}</div>
            <button class="ghost" style="margin-top:8px" onclick="openTicketDetailModal('${ticket.id}')">Ver detalle</button>
          </div>
        `
      }

      return `
        <div class="ticket">
          <h5>${htmlEscape(ticket.title||"-")}</h5>
          <p>${htmlEscape(ticket.description||"-")}</p>
          <div class="meta">Cliente/츼rea: ${htmlEscape(ticket.client||"-")}</div>
          <div class="meta">Prioridad: ${htmlEscape(ticket.priority||"Media")}</div>
          <div class="meta">Creado por ${htmlEscape(ticket.createdBy||"-")} 췅 ${ticket.createdAt?new Date(ticket.createdAt).toLocaleString():"-"}</div>
          <div class="meta">Asignado a: ${htmlEscape(ticket.assignedTo||"Sin asignar")}</div>
          ${renderTicketActions(ticket.id, status)}
          ${renderComments(ticket.id, ticket.comments || {})}
        </div>
      `
    }

    async function openTicketDetailModal(id){
      const ticket = cachedTickets.find(t => t.id === id)
      if(!ticket) return alert("No se encontr칩 el ticket")

      document.getElementById("ticketDetailContent").innerHTML = `
        <div class="row">
          <div><label>T칤tulo</label><input value="${htmlEscape(ticket.title||"")}" disabled></div>
          <div><label>Prioridad</label><input value="${htmlEscape(ticket.priority||"Media")}" disabled></div>
        </div>
        <div><label>Detalle</label><textarea disabled>${htmlEscape(ticket.description||"")}</textarea></div>
        <div><label>Cliente/츼rea</label><input value="${htmlEscape(ticket.client||"")}" disabled></div>
        <div><label>Asignado a</label><input value="${htmlEscape(ticket.assignedTo||"Sin asignar")}" disabled></div>
        ${renderComments(id, ticket.comments || {})}
      `
      document.getElementById("ticketDetailModal").classList.remove("hidden")
    }

    function closeTicketDetailModal(){
      document.getElementById("ticketDetailModal").classList.add("hidden")
      document.getElementById("ticketDetailContent").innerHTML = ""
    }

    function renderTicketActions(id, currentStatus){
      const options = Object.entries(STATUS)
        .filter(([key]) => key !== currentStatus)
        .map(([key, label]) => `<option value="${key}">${label}</option>`)
        .join("")

      const canDelete = currentRole === "admin"
      const canMove = currentRole === "admin" || currentRole === "analista"
      const canAssign = currentRole === "admin" || currentRole === "analista"

      const assignSelect = canAssign ? `
        <div class="inline" style="margin-top:8px;width:100%">
          <input id="assign-${id}" placeholder="Email analista" style="margin:0;min-width:170px" />
          <button class="ghost" onclick="assignTicket('${id}')">Asignar</button>
        </div>
      ` : ""

      const moveBlock = canMove ? `
        <select id="next-${id}" style="margin:0;min-width:160px">
          ${options}
        </select>
        <button class="ghost" onclick="moveTicket('${id}')">Mover</button>
      ` : `<span class="small">Solo admin/analista pueden mover estados</span>`

      return `
        <div class="inline" style="margin-top:8px">
          ${moveBlock}
          ${canDelete?`<button class="danger" onclick="deleteTicket('${id}')">Borrar</button>`:""}
        </div>
        ${assignSelect}
      `
    }

    function renderComments(id, comments){
      const list = Object.values(comments || {}).sort((a,b)=>new Date(a.createdAt||0)-new Date(b.createdAt||0))
      return `
        <div style="margin-top:10px;border-top:1px solid rgba(148,163,184,.2);padding-top:8px">
          <div class="small" style="margin-bottom:6px">Comentarios</div>
          ${list.length ? list.map(c=>`<div class="small" style="margin-bottom:4px"><strong>${htmlEscape(c.author||"-")}</strong>: ${htmlEscape(c.message||"")} <span style="opacity:.8">(${c.createdAt?new Date(c.createdAt).toLocaleString():""})</span></div>`).join("") : `<div class="small">Sin comentarios</div>`}
          <div class="inline" style="margin-top:6px">
            <input id="comment-${id}" placeholder="Escrib칤 un comentario" style="margin:0" />
            <button class="ghost" onclick="addComment('${id}')">Comentar</button>
          </div>
        </div>
      `
    }

    async function moveTicket(id){
      if(!(currentRole === "admin" || currentRole === "analista")) return alert("No ten칠s permisos para mover tickets")
      const next = document.getElementById(`next-${id}`)?.value
      if(!next) return

      const ticket = cachedTickets.find(t => t.id === id)
      if(!ticket) return
      const updated = { ...ticket, status: next, updatedAt: new Date().toISOString(), updatedBy: currentUser.email }
      await sheetWrite("updateTicket", updated)
      logActivity("ticket_movido", { ticketId: id, nextStatus: next })
      await loadTickets()
      await loadDashboard()
    }

    async function assignTicket(id){
      if(!(currentRole === "admin" || currentRole === "analista")) return alert("No ten칠s permisos para asignar tickets")
      const assignedTo = (document.getElementById(`assign-${id}`)?.value || "").trim().toLowerCase()
      if(!assignedTo) return alert("Ingres치 el email del analista")

      const user = (await db.ref("users_by_email").child(emailKey(assignedTo)).once("value")).val()
      if(!user || user.role !== "analista") return alert("El usuario no existe o no es analista")

      const ticket = cachedTickets.find(t => t.id === id)
      if(!ticket) return
      const updated = { ...ticket, assignedTo, updatedAt: new Date().toISOString(), updatedBy: currentUser.email }
      await sheetWrite("updateTicket", updated)
      logActivity("ticket_asignado", { ticketId: id, assignedTo })
      await loadTickets()
    }

    async function addComment(id){
      const message = (document.getElementById(`comment-${id}`)?.value || "").trim()
      if(!message) return

      const ticket = cachedTickets.find(t => t.id === id)
      if(!ticket) return
      const comments = { ...(ticket.comments || {}) }
      comments[generateId()] = { message, author: currentUser.email, createdAt: new Date().toISOString() }
      const updated = { ...ticket, comments, updatedAt: new Date().toISOString(), updatedBy: currentUser.email }

      await sheetWrite("updateTicket", updated)
      const input = document.getElementById(`comment-${id}`)
      if(input) input.value = ""
      logActivity("ticket_comentario", { ticketId: id })
      await loadTickets()
      const detailOpen = !document.getElementById("ticketDetailModal").classList.contains("hidden")
      if(detailOpen) openTicketDetailModal(id)
    }

    async function deleteTicket(id){
      if(!confirm("쯉eguro que quer칠s borrar este ticket?")) return
      await sheetWrite("deleteTicket", { id })
      logActivity("ticket_borrado", { ticketId: id })
      await loadTickets()
      await loadDashboard()
    }

    async function saveUserAccess(){
      if(currentRole !== "admin") return alert("Solo admin puede crear usuarios")
      const email = document.getElementById("uEmail").value.trim().toLowerCase()
      const password = document.getElementById("uPassword").value.trim()
      const role = document.getElementById("uRole").value
      if(!email || !password) return alert("Complet치 email y contrase침a")

      await db.ref("users_by_email").child(emailKey(email)).set({
        email, password, role, active: true,
        createdAt: new Date().toISOString(), createdBy: currentUser.email
      })
      alert("Usuario creado correctamente")
    }

    function loadUsersAdmin(){
      const container = document.getElementById("usersList")
      if(!container) return

      db.ref("users_by_email").off()
      db.ref("users_by_email").on("value", snap => {
        const items = Object.entries(snap.val() || {})
        if(!items.length){ container.innerHTML = "Sin usuarios cargados"; return }

        container.innerHTML = items.map(([k,u]) => {
          const isSelf = (u.email||"").toLowerCase() === (currentUser.email||"").toLowerCase()
          return `<div class="card" style="padding:10px;margin:6px 0"><div class="inline" style="justify-content:space-between"><div><strong>${htmlEscape(u.email||"-")}</strong><br><span class="small">Rol: ${htmlEscape(u.role||"-")} 췅 Clave: Oculta</span></div><div class="inline"><button class="danger" ${isSelf?"disabled":""} onclick="deleteUserAccess('${k}','${u.email||''}')">Eliminar</button></div></div></div>`
        }).join("")
      })
    }

    async function deleteUserAccess(key,email){
      if(currentRole !== "admin") return alert("Solo admin puede eliminar usuarios")
      if(!confirm(`쮼liminar acceso para ${email}?`)) return
      await db.ref("users_by_email").child(key).remove()
    }

    async function loadDashboard(){
      try{
        const ticketsArr = await fetchTicketsFromSheet()
        const users = Object.values((await db.ref("users_by_email").once("value")).val() || {})
        const activity = Object.values((await db.ref("activity_logs").limitToLast(10).once("value")).val() || {})

        let total = 0, unassigned = 0, doing = 0, done = 0
        ticketsArr.forEach(t => {
          total++
          if(t.status === "unassigned") unassigned++
          if(t.status === "doing") doing++
          if(t.status === "done") done++
        })

        const ops = users.filter(u => u && u.role === "analista")
        const last = ops.map(u => u.lastAccessAt ? new Date(u.lastAccessAt).getTime() : 0).sort((a,b)=>b-a)[0] || 0

        document.getElementById("kpiTotal").innerText = total
        document.getElementById("kpiUnassigned").innerText = unassigned
        document.getElementById("kpiDoing").innerText = doing
        document.getElementById("kpiDone").innerText = done
        document.getElementById("kpiOperators").innerText = ops.length
        const lastAccessEl = document.getElementById("kpiLastAccess")
        if(lastAccessEl){
          lastAccessEl.innerText = last ? new Date(last).toLocaleString() : "Sin accesos"
        }

        const container = document.getElementById("recentActivity")
        if(!container) return
        const sorted = activity.sort((a,b)=>new Date(b.timestampIso||0)-new Date(a.timestampIso||0))
        if(!sorted.length){
          container.innerHTML = `<p class="small">Sin actividad reciente.</p>`
        }else{
          container.innerHTML = sorted.map(it => `
            <div class="feedItem">
              <div class="feedTop">
                <div>
                  <div class="feedType">${htmlEscape(it.eventType || "evento")}</div>
                  <div class="feedMeta">${htmlEscape(it.email || "sin-usuario")} 췅 ${it.timestampIso ? new Date(it.timestampIso).toLocaleString() : ""}</div>
                </div>
                <span class="badge ${it.role === "admin" ? "ok" : "off"}">${htmlEscape(it.role || "-")}</span>
              </div>
            </div>
          `).join("")
        }
      }catch(_){ }
    }

    async function init(){
      renderLogin()
      await ensureDefaultUsers()
    }

    init()
  </script>
</body>
</html>
