<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tablero de Tickets</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27%3E%3Ctext y=%2750%27 font-size=%2750%27%3E游꿞%3C/text%3E%3C/svg%3E" />

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root{--bg-1:#030712;--bg-2:#0b1220;--surface:rgba(15,23,42,.58);--stroke:rgba(148,163,184,.24);--text:#e2e8f0;--muted:#94a3b8;--accent:#7c3aed;--accent-2:#06b6d4;--danger:#dc2626;--ok:#16a34a}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);background:radial-gradient(1000px 500px at 10% -10%,rgba(124,58,237,.3),transparent 55%),radial-gradient(900px 500px at 100% -20%,rgba(6,182,212,.25),transparent 60%),linear-gradient(180deg,var(--bg-2),var(--bg-1));min-height:100vh;padding:clamp(12px,2.4vw,26px)}
    .container{max-width:1400px;margin:auto}
    .card{background:var(--surface);backdrop-filter:blur(14px);border:1px solid var(--stroke);border-radius:16px;padding:clamp(12px,1.6vw,16px);margin-bottom:12px;box-shadow:0 10px 40px rgba(0,0,0,.28);animation:fadeIn .35s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    button,.btn{border:none;color:#fff;padding:10px 14px;font-size:14px;border-radius:10px;cursor:pointer;background:linear-gradient(135deg,var(--accent),#4338ca);transition:transform .18s ease, box-shadow .2s ease, opacity .2s ease;box-shadow:0 6px 18px rgba(124,58,237,.35)}
    button:hover,.btn:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(124,58,237,.35)}
    button.secondary{background:#1e293b;box-shadow:none}
    button.danger{background:linear-gradient(135deg,#ef4444,var(--danger));box-shadow:0 6px 16px rgba(220,38,38,.4)}
    button.ghost{background:rgba(30,41,59,.4);border:1px solid rgba(148,163,184,.25);box-shadow:none}
    button:disabled{opacity:.45;cursor:not-allowed;transform:none}
    label{font-size:12px;color:#cbd5e1;display:block;margin:0 0 6px}
    input,select,textarea{width:100%;padding:11px 12px;font-size:14px;border-radius:11px;border:1px solid rgba(148,163,184,.24);background:rgba(2,6,23,.6);color:var(--text);margin-bottom:10px;outline:none;transition:border-color .2s ease, box-shadow .2s ease}
    input:focus,select:focus,textarea:focus{border-color:var(--accent-2);box-shadow:0 0 0 3px rgba(6,182,212,.2)}
    textarea{min-height:86px;resize:vertical}
    .small{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap}.row>*{flex:1 1 220px}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;align-items:stretch}
    @media (min-width:980px){.grid{grid-template-columns:1.2fr .9fr}}
    .badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--stroke)}
    .badge.ok{color:#86efac;border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12)}
    .badge.off{color:#fca5a5;border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12)}
    .searchWrap{position:relative}.searchWrap input{padding-left:36px;margin:0}.searchWrap:before{content:'游댍';position:absolute;left:11px;top:8px;opacity:.65}
    .kpiGrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .kpiGrid.singleRow{grid-template-columns:repeat(5,minmax(0,1fr))!important}
    @media (max-width:900px){.kpiGrid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .kpi{padding:12px;border:1px solid var(--stroke);border-radius:14px;background:rgba(2,6,23,.35)}
    .kpi .label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px}
    .kpi .value{font-size:22px;margin-top:4px}
    .feedItem{padding:10px;border:1px solid rgba(148,163,184,.14);border-radius:12px;background:rgba(2,6,23,.25);margin-bottom:8px}
    .feedTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .feedType{font-weight:600}
    .feedMeta{font-size:12px;color:var(--muted);margin-top:4px}

    .boardWrap{overflow-x:auto;overflow-y:visible;padding-bottom:4px}
    .board{display:grid;grid-template-columns:repeat(5,minmax(260px,1fr));gap:12px;overflow:visible;align-items:start}
    .column{background:rgba(2,6,23,.35);border:1px solid var(--stroke);border-radius:12px;padding:10px;min-height:220px;height:100%;display:flex;flex-direction:column}
    .column h4{margin:4px 0 10px;font-size:14px;text-transform:uppercase;color:#cbd5e1;letter-spacing:.3px}
    .ticket{background:rgba(15,23,42,.8);border:1px solid rgba(148,163,184,.2);border-radius:10px;padding:10px;margin-bottom:8px}
    .ticket h5{margin:0 0 8px;font-size:14px}
    .ticketCode{font-size:11px;color:#94a3b8;font-weight:600;margin-right:6px}
    .deadline{color:#f87171}
    .ticket p{margin:0 0 8px;font-size:13px;color:#cbd5e1}
    .ticket .meta{font-size:11px;color:var(--muted)}
    .modalBack{position:fixed;inset:0;background:rgba(2,6,23,.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:16px;z-index:99}
    .modal{width:min(760px,100%);max-height:90vh;overflow:auto}
    .hidden{display:none!important}
    .urgentBtn{background:linear-gradient(135deg,#f59e0b,#ef4444);box-shadow:0 6px 18px rgba(239,68,68,.35)}
    .urgentFlag{font-size:11px;color:#fecaca;margin-top:6px}
    .toast{position:fixed;right:16px;bottom:16px;z-index:120;min-width:260px;max-width:420px;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);background:rgba(15,23,42,.95);box-shadow:0 8px 24px rgba(0,0,0,.35);font-size:13px}
    .toast.ok{border-color:rgba(22,163,74,.65)}
    .toast.error{border-color:rgba(220,38,38,.65)}
  </style>
</head>
<body>
  <div class="container" id="app"></div>

  <div id="ticketModal" class="modalBack hidden">
    <div class="card modal">
      <div class="inline" style="justify-content:space-between;margin-bottom:8px">
        <h3 style="margin:0">Nuevo ticket</h3>
        <button class="secondary" onclick="closeTicketModal()">Cerrar</button>
      </div>

      <div class="row">
        <div><label>T칤tulo</label><input id="tTitle" /></div>
        <div><label>Prioridad</label><select id="tPriority"><option value="Baja">Baja</option><option value="Media">Media</option><option value="Alta">Alta</option></select></div>
      </div>
      <div><label>Detalle</label><textarea id="tDescription"></textarea></div>
      <div class="row">
        <div><label>Cliente/츼rea</label><select id="tClient"></select></div>
        <div><label>Deadline</label><input id="tDeadline" type="date" onkeydown="return false" onfocus="this.showPicker && this.showPicker()" /></div>
      </div>

      <div class="inline" style="justify-content:flex-end">
        <button onclick="saveTicket()">Crear ticket</button>
        <button class="secondary" onclick="closeTicketModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="ticketDetailModal" class="modalBack hidden">
    <div class="card modal">
      <div class="inline" style="justify-content:space-between;margin-bottom:8px">
        <h3 style="margin:0">Detalle de ticket</h3>
        <button class="secondary" onclick="closeTicketDetailModal()">Cerrar</button>
      </div>
      <div id="ticketDetailContent"></div>
    </div>
  </div>

  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyA4-yTeI0CemnlROxF9hIgj_HxiDLvYZTY",
      authDomain: "tablero-a0658.firebaseapp.com",
      databaseURL: "https://tablero-a0658-default-rtdb.firebaseio.com",
      projectId: "tablero-a0658",
      storageBucket: "tablero-a0658.firebasestorage.app",
      messagingSenderId: "1018762078941",
      appId: "1:1018762078941:web:785861e9f2ddb843b88934"
    })

    const db = firebase.database()
    const DEFAULT_USERS = [
      { email: "admin@tablero.local", password: "1234", role: "admin" },
      { email: "consultor@tablero.local", password: "1234", role: "consultor" },
      { email: "analista@tablero.local", password: "1234", role: "analista" }
    ]

    var currentUser = globalThis.currentUser || null
    var currentRole = globalThis.currentRole || null
    var ticketSearchTerm = globalThis.ticketSearchTerm || ""
    var ticketFilterConsultor = globalThis.ticketFilterConsultor || ""
    var ticketFilterClient = globalThis.ticketFilterClient || ""
    var cachedClients = globalThis.cachedClients || []
    var cachedConsultors = globalThis.cachedConsultors || []
    var consultorRefreshTimer = globalThis.consultorRefreshTimer || null

    const STATUS = {
      unassigned: "Pendientes de asignar",
      todo: "Por hacer",
      doing: "En curso",
      recurrent: "Recurrente",
      done: "Finalizadas"
    }

    const SHEET_ID = "1tNNtG2Asr1ds1_-3P6PmVgsHbdlhhfrV7GhWJDiTO1Q"
    const SHEET_GID = "0"
    const SHEET_TICKETS_NAME = "BD"
    const SHEET_ADMINS_NAME = "BD_ADMINS"
    // Reemplazar por tu URL de Web App de Apps Script para habilitar escritura en la hoja.
    // Debe aceptar JSON { action, payload } para createTicket/updateTicket/deleteTicket.
    const SHEET_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbyRLv3IqWF7O-045AsuEQzqOn2FstgF8X3TfBXQB6eSLJr44u6nm3QUQH_mtBaSjVYUhw/exec"
    let cachedTickets = []

    function emailKey(email){ return (email||"").toLowerCase().replace(/[.#$/\[\]]/g, "_") }
    function htmlEscape(v){ return String(v??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;") }
    function generateId(){ return (crypto?.randomUUID?.() || `tk_${Date.now()}_${Math.random().toString(36).slice(2,8)}`) }
    function parseGvizJson(text){
      const raw = text.replace(/^\/\/O_o\s*\n/, "")
      const start = raw.indexOf("{")
      const end = raw.lastIndexOf("}")
      return JSON.parse(raw.slice(start, end + 1))
    }


    function showToast(message, type="info", keepMs=2200){
      const old = document.getElementById("globalToast")
      if(old) old.remove()
      const el = document.createElement("div")
      el.id = "globalToast"
      el.className = `toast ${type}`
      el.textContent = message
      document.body.appendChild(el)
      setTimeout(()=>{ if(el.parentNode) el.remove() }, keepMs)
    }

    function buildTicketCode(list){
      const max = (list||[]).reduce((acc, t) => {
        const m = String(t.id||"").match(/^TAO-(\d+)$/)
        if(!m) return acc
        return Math.max(acc, Number(m[1]))
      }, 0)
      const next = max + 1
      return `TAO-${String(next).padStart(2,"0")}`
    }


    async function fetchAdminsRowsFromSheet(){
      const query = encodeURIComponent("select A,B,C,D,E,F,G,H,I,J,K")
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_ADMINS_NAME)}&tq=${query}`
      const res = await fetch(url)
      if(!res.ok) throw new Error("No se pudo leer BD_ADMINS")
      const gviz = parseGvizJson(await res.text())
      const rows = gviz?.table?.rows || []
      return rows.map(r => (r.c || []).map(c => c?.v ?? ""))
    }

    async function fetchUsersFromSheet(){
      const rows = await fetchAdminsRowsFromSheet()
      return rows
        .filter(cols => String(cols[0]||"").toLowerCase() === "user")
        .map(cols => ({
          key: String(cols[1]||""),
          email: String(cols[2]||""),
          password: String(cols[3]||""),
          role: String(cols[4]||"consultor"),
          active: String(cols[5]||"true") !== "false",
          createdAt: String(cols[6]||""),
          createdBy: String(cols[7]||""),
          lastAccessAt: String(cols[8]||"")
        }))
    }

    async function fetchClientsFromSheet(){
      const rows = await fetchAdminsRowsFromSheet()
      return rows
        .filter(cols => String(cols[0]||"").toLowerCase() === "client")
        .map(cols => ({ key: String(cols[1]||""), name: String(cols[2]||"") }))
        .filter(c => c.name)
    }

    async function adminWrite(action, payload){
      return sheetWrite(action, payload)
    }

    function mirrorToSheet(action, payload){
      sheetWrite(action, payload).catch(err => {
        console.warn("No se pudo espejar en Sheets:", action, err)
      })
    }

    async function fetchTicketsFromDb(){
      const snap = await db.ref("tickets").once("value")
      const data = snap.val() || {}
      return Object.entries(data).map(([id,t]) => ({ id, ...t }))
    }


    function startConsultorAutoRefresh(){
      if(consultorRefreshTimer) clearInterval(consultorRefreshTimer)
      consultorRefreshTimer = setInterval(() => {
        loadTickets()
        loadDashboard()
      }, 8000)
      globalThis.consultorRefreshTimer = consultorRefreshTimer
    }

    function stopConsultorAutoRefresh(){
      if(consultorRefreshTimer) clearInterval(consultorRefreshTimer)
      consultorRefreshTimer = null
      globalThis.consultorRefreshTimer = null
    }

    async function loadFilterOptions(){
      const users = Object.values((await db.ref("users_by_email").once("value")).val() || {})
      cachedConsultors = users.filter(u => u && u.role === "consultor" && u.active !== false).map(u => (u.email||"").toLowerCase())
      globalThis.cachedConsultors = cachedConsultors

      const clients = Object.values((await db.ref("clients").once("value")).val() || {})
      cachedClients = clients.map(c => String(c.name||"").trim()).filter(Boolean).sort((a,b)=>a.localeCompare(b,'es'))
      globalThis.cachedClients = cachedClients

      const consultorSelect = document.getElementById("filterConsultor")
      if(consultorSelect){
        consultorSelect.innerHTML = `<option value="">Todos los consultores</option>${cachedConsultors.map(c => `<option value="${htmlEscape(c)}">${htmlEscape(c)}</option>`).join("")}`
        consultorSelect.value = ticketFilterConsultor
      }

      const clientFilterSelect = document.getElementById("filterClient")
      if(clientFilterSelect){
        clientFilterSelect.innerHTML = `<option value="">Todos los clientes</option>${cachedClients.map(c => `<option value="${htmlEscape(c)}">${htmlEscape(c)}</option>`).join("")}`
        clientFilterSelect.value = ticketFilterClient
      }

      const ticketClientSelect = document.getElementById("tClient")
      if(ticketClientSelect){
        ticketClientSelect.innerHTML = `<option value="">Seleccionar cliente</option>${cachedClients.map(c => `<option value="${htmlEscape(c)}">${htmlEscape(c)}</option>`).join("")}`
      }
    }

    async function saveClient(){
      if(currentRole !== "admin") return alert("Solo admin puede agregar clientes")
      const name = (document.getElementById("cName")?.value || "").trim()
      if(!name) return alert("Ingres치 un cliente")
      await db.ref("clients").child(emailKey(name)).set({ name, createdAt: new Date().toISOString(), createdBy: currentUser.email })
      mirrorToSheet("upsertClient", { key: emailKey(name), name, createdAt: new Date().toISOString(), createdBy: currentUser.email })
      const input = document.getElementById("cName")
      if(input) input.value = ""
      showToast("Cliente agregado", "ok")
      await loadClientsAdmin()
      await loadFilterOptions()
    }

    async function deleteClient(key){
      if(currentRole !== "admin") return alert("Solo admin puede eliminar clientes")
      if(!confirm("쮼liminar cliente?")) return
      await db.ref("clients").child(key).remove()
      mirrorToSheet("deleteClient", { key })
      showToast("Cliente eliminado", "ok")
      await loadClientsAdmin()
      await loadFilterOptions()
    }

    async function loadClientsAdmin(){
      const container = document.getElementById("clientsList")
      if(!container) return
      const clients = Object.entries((await db.ref("clients").once("value")).val() || {})
      if(!clients.length){ container.innerHTML = "Sin clientes"; return }
      container.innerHTML = clients.map(([k,c]) => `<div class="inline" style="justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(148,163,184,.15)"><span>${htmlEscape(c.name||"")}</span><button class="danger" onclick="deleteClient('${k}')">Eliminar</button></div>`).join("")
    }

    async function fetchTicketsFromSheet(){
      const query = encodeURIComponent("select A,B,C,D,E,F,G,H,I,J,K,L,M,N")
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_TICKETS_NAME)}&tq=${query}`
      const res = await fetch(url)
      if(!res.ok) throw new Error("No se pudo leer la planilla")
      const gviz = parseGvizJson(await res.text())
      const rows = gviz?.table?.rows || []

      return rows
        .map(r => (r.c || []).map(c => c?.v ?? ""))
        .filter(cols => (cols[0]||"").toString().trim())
        .map(cols => ({
          id: String(cols[0]||""),
          title: String(cols[1]||""),
          description: String(cols[2]||""),
          priority: String(cols[3]||"Media"),
          client: String(cols[4]||""),
          status: String(cols[5]||"unassigned"),
          assignedTo: String(cols[6]||""),
          comments: (() => { try{ return JSON.parse(cols[7]||"{}") }catch(_){ return {} } })(),
          createdAt: String(cols[8]||""),
          createdBy: String(cols[9]||""),
          updatedAt: String(cols[10]||""),
          updatedBy: String(cols[11]||""),
          deadline: String(cols[12]||""),
          urgentRequested: String(cols[13]||"false") === "true"
        }))
    }

    async function sheetWrite(action, payload){
      if(!SHEET_WEBHOOK_URL){
        alert("Falta configurar SHEET_WEBHOOK_URL para guardar cambios en Google Sheets")
        throw new Error("SHEET_WEBHOOK_URL no configurada")
      }

      // Enviamos text/plain para evitar preflight CORS en hosting est치tico (GitHub Pages).
      const requestBody = JSON.stringify({ action, payload, sheetId: SHEET_ID, gid: SHEET_GID, ticketSheet: SHEET_TICKETS_NAME, adminSheet: SHEET_ADMINS_NAME })
      const res = await fetch(SHEET_WEBHOOK_URL, {
        method: "POST",
        mode: "cors",
        redirect: "follow",
        body: requestBody
      })

      if(!res.ok) throw new Error(`No se pudo escribir en Google Sheets (${res.status})`)
      const data = await res.json().catch(() => ({ ok: true }))
      if(data && data.ok === false){
        const rawError = String(data.error || "Error al guardar en Google Sheets")
        if(rawError.includes("setHeaders")) throw new Error("Tu Apps Script est치 desactualizado (usa response.setHeaders). Reemplaz치 el script por APPS_SCRIPT.gs y volv칠 a desplegar la Web App.")
        throw new Error(rawError)
      }
      return data
    }

    async function logActivity(eventType, details={}){
      try{
        await db.ref("activity_logs").push({
          eventType,
          email: currentUser?.email || "sin-usuario",
          role: currentRole || "sin-rol",
          timestampIso: new Date().toISOString(),
          ...details
        })
      }catch(_){ }
    }

    async function ensureDefaultUsers(){
      for(const user of DEFAULT_USERS){
        const ref = db.ref("users_by_email").child(emailKey(user.email))
        const snap = await ref.once("value")
        if(!snap.exists()){
          await ref.set({
            email: user.email,
            password: user.password,
            role: user.role,
            active: true,
            createdAt: new Date().toISOString(),
            createdBy: "system"
          })
        }
      }
    }

    async function getUserFromDb(email){
      const snap = await db.ref("users_by_email").child(emailKey(email)).once("value")
      return snap.val()
    }

    function renderLogin(){
      document.getElementById("app").innerHTML = `
        <div class="card" style="max-width:480px;margin:40px auto">
          <h2 style="margin-top:0">Tablero de tickets</h2>
          <p class="small">Acceso por Email + Contrase침a.</p>
          <label>Email</label><input id="loginEmail" type="email">
          <label>Contrase침a</label><input id="loginPassword" type="password">
          <button onclick="handleLogin()" style="width:100%">Entrar</button>
          <p class="small" style="margin-top:10px">Usuarios iniciales: admin@tablero.local, consultor@tablero.local, analista@tablero.local (clave: 1234)</p>
        </div>`
    }

    async function handleLogin(){
      const email = document.getElementById("loginEmail").value.trim().toLowerCase()
      const password = document.getElementById("loginPassword").value
      if(!email || !password) return alert("Complet치 email y contrase침a")

      const user = await getUserFromDb(email)
      if(!user || !user.active) return alert("Usuario inexistente o inactivo")
      if(user.password !== password) return alert("Contrase침a incorrecta")

      currentUser = { email: user.email }
      currentRole = user.role

      await db.ref("users_by_email").child(emailKey(email)).update({ lastAccessAt: new Date().toISOString() })
      logActivity("login", { userAgent: navigator.userAgent })
      renderApp()
    }

    function logout(){ stopConsultorAutoRefresh(); currentUser = null; currentRole = null; renderLogin() }

    function renderApp(){
      const isAdmin = currentRole === "admin"
      const canCreateTicket = currentRole === "admin" || currentRole === "analista" || currentRole === "consultor"

      document.getElementById("app").innerHTML = `
        <div class="grid">
          <div class="card">
            <div class="inline" style="justify-content:space-between">
              <div>
                <h2 style="margin:0">Tablero de tickets</h2>
                <p class="small" style="margin:6px 0 0">Panel ${htmlEscape(currentRole)} 췅 ${htmlEscape(currentUser.email)}</p>
              </div>
              <div class="inline">
                ${canCreateTicket?`<button onclick="openTicketModal()">+ Nuevo ticket</button>`:""}
                <button class="secondary" onclick="logout()">Cerrar sesi칩n</button>
              </div>
            </div>

            <div style="margin-top:14px">
              <h3 style="margin:0 0 10px">Dashboard</h3>
              <div class="kpiGrid ${currentRole === "consultor" ? "singleRow" : ""}">
                <div class="kpi"><div class="label">Tickets totales</div><div class="value" id="kpiTotal">-</div></div>
                <div class="kpi"><div class="label">Pendientes de asignar</div><div class="value" id="kpiUnassigned">-</div></div>
                <div class="kpi"><div class="label">En curso</div><div class="value" id="kpiDoing">-</div></div>
                <div class="kpi"><div class="label">Finalizadas</div><div class="value" id="kpiDone">-</div></div>
                <div class="kpi"><div class="label">Analistas</div><div class="value" id="kpiOperators">-</div></div>
                ${currentRole !== "consultor" ? `<div class="kpi"><div class="label">칔ltimo acceso analista</div><div class="value" style="font-size:14px;margin-top:8px" id="kpiLastAccess">-</div></div>` : ""}
              </div>
              ${currentRole !== "consultor" ? `
              <div style="margin-top:14px">
                <div class="inline" style="justify-content:space-between;align-items:center">
                  <h3 style="margin:0">Actividad reciente</h3>
                  <button class="ghost" onclick="loadDashboard()">Actualizar</button>
                </div>
                <div id="recentActivity" style="margin-top:10px"></div>
              </div>
              ` : ``}
            </div>
          </div>

          ${isAdmin?`
            <div class="card">
              <h3 style="margin-top:0">Gesti칩n de usuarios</h3>
              <div class="row">
                <div><label>Email</label><input id="uEmail"></div>
                <div><label>Contrase침a</label><input id="uPassword" type="text"></div>
              </div>
              <div class="row">
                <div><label>Rol</label><select id="uRole"><option value="consultor">Consultor</option><option value="analista">Analista</option><option value="admin">Admin</option></select></div>
                <div style="display:flex;align-items:flex-end"><button onclick="saveUserAccess()">Guardar usuario</button></div>
              </div>
              <div id="usersList" class="small"></div>
              <hr style="border-color:rgba(148,163,184,.2);margin:12px 0">
              <h4 style="margin:0 0 8px">Clientes</h4>
              <div class="row">
                <div><label>Nuevo cliente</label><input id="cName"></div>
                <div style="display:flex;align-items:flex-end"><button onclick="saveClient()">Agregar cliente</button></div>
              </div>
              <div id="clientsList" class="small"></div>
            </div>
          ` : currentRole === "consultor" ? `
            <div class="card">
              <div class="inline" style="justify-content:space-between;align-items:center">
                <h3 style="margin:0">Actividad de comentarios</h3>
                </div>
              <div id="consultorCommentsActivity" style="margin-top:10px;max-height:300px;overflow-y:auto;padding-right:4px"></div>
            </div>
          ` : "<div></div>"}
        </div>

        <div class="card">
          <div class="inline" style="justify-content:space-between;margin-bottom:10px">
            <h3 style="margin:0">Tickets</h3>
            <span class="small">Vista Kanban de operaci칩n</span>
          </div>
          <div class="row">
            <div class="searchWrap"><input oninput="updateTicketSearch(this.value)" placeholder="Buscar por t칤tulo, cliente o descripci칩n"></div>
            <div><select id="filterConsultor" onchange="updateConsultorFilter(this.value)"><option value="">Todos los consultores</option></select></div>
            <div><select id="filterClient" onchange="updateClientFilter(this.value)"><option value="">Todos los clientes</option></select></div>
          </div>
        </div>

        <div class="card"><div class="boardWrap"><div id="boardContainer"></div></div></div>
      `

      if(isAdmin){ loadUsersAdmin(); loadClientsAdmin() }
      if(currentRole === "consultor") startConsultorAutoRefresh(); else stopConsultorAutoRefresh()
      loadFilterOptions()
      loadTickets()
      loadDashboard()
    }

    function updateTicketSearch(value){ ticketSearchTerm = (value||"").trim().toLowerCase(); globalThis.ticketSearchTerm = ticketSearchTerm; loadTickets() }
    function updateConsultorFilter(value){ ticketFilterConsultor = (value||"").trim().toLowerCase(); globalThis.ticketFilterConsultor = ticketFilterConsultor; loadTickets() }
    function updateClientFilter(value){ ticketFilterClient = (value||"").trim().toLowerCase(); globalThis.ticketFilterClient = ticketFilterClient; loadTickets() }

    function openTicketModal(){ document.getElementById("ticketModal").classList.remove("hidden") }
    function closeTicketModal(){
      document.getElementById("tTitle").value = ""
      document.getElementById("tDescription").value = ""
      document.getElementById("tPriority").value = "Media"
      document.getElementById("tClient").value = ""
      document.getElementById("tDeadline").value = ""
      document.getElementById("ticketModal").classList.add("hidden")
    }

    async function saveTicket(){
      const title = document.getElementById("tTitle").value.trim()
      const description = document.getElementById("tDescription").value.trim()
      const priority = document.getElementById("tPriority").value
      const client = document.getElementById("tClient").value.trim()
      const deadline = document.getElementById("tDeadline").value

      if(!title || !description || !client) return alert("Complet치 t칤tulo, detalle y cliente/치rea")

      showToast("Creando ticket...", "info", 1600)
      const now = new Date().toISOString()
      const code = buildTicketCode(cachedTickets)
      const ticket = {
        id: code,
        title, description, priority, client, deadline,
        status: "unassigned",
        assignedTo: "",
        comments: {},
        createdAt: now,
        createdBy: currentUser.email,
        updatedAt: now,
        updatedBy: currentUser.email
      }

      const ref = await db.ref("tickets").push(ticket)
      const savedTicket = { ...ticket, id: ref.key }
      mirrorToSheet("createTicket", savedTicket)
      cachedTickets.unshift(savedTicket)
      renderTicketsFromData(cachedTickets)
      logActivity("ticket_creado", { title, client, code })
      closeTicketModal()
      loadDashboard()
      showToast(`Ticket ${code} creado correctamente`, "ok")
    }

    function loadTickets(){
      const container = document.getElementById("boardContainer")
      if(!container) return

      db.ref("tickets").off()
      db.ref("tickets").on("value", snap => {
        const data = Object.entries(snap.val() || {}).map(([id,t]) => ({ id, ...t }))
        cachedTickets = data
        renderTicketsFromData(data)
      })
    }

    function renderTicketsFromData(data){
      const container = document.getElementById("boardContainer")
      if(!container) return
      const grouped = { unassigned: [], todo: [], doing: [], recurrent: [], done: [] }

      Object.entries(data).forEach(([_, t]) => {
        const canSeeTicket = currentRole === "admin" || currentRole === "analista" || (currentRole === "consultor" && (t.createdBy||"") === currentUser.email)
        if(!canSeeTicket) return

        const haystack = `${t.title||""} ${t.description||""} ${t.client||""} ${t.createdBy||""}`.toLowerCase()
        if(ticketSearchTerm && !haystack.includes(ticketSearchTerm)) return
        if(ticketFilterConsultor && !(String(t.createdBy||"").toLowerCase().includes(ticketFilterConsultor))) return
        if(ticketFilterClient && !(String(t.client||"").toLowerCase().includes(ticketFilterClient))) return

        const status = grouped[t.status] ? t.status : "unassigned"
        grouped[status].push(t)
      })

      const maxTicketsInColumn = Math.max(...Object.values(grouped).map(arr => arr.length), 0)
      const uniformHeight = Math.max(220, 120 + maxTicketsInColumn * 190)

      container.innerHTML = `<div class="board">${Object.entries(STATUS).map(([status, label]) => `
        <div class="column" style="min-height:${uniformHeight}px">
          <h4>${label} <span class="small">(${grouped[status].length})</span></h4>
          ${grouped[status].map(t => renderTicketCard(t, status)).join("") || `<p class="small">Sin tickets</p>`}
        </div>
      `).join("")}</div>`
    }

    function renderTicketCard(ticket, status){
      if(currentRole === "consultor"){
        return `
          <div class="ticket">
            <h5><span class="ticketCode">${htmlEscape(ticket.id||"-")}</span>${htmlEscape(ticket.title||"-")}</h5>
            <div class="meta">Asignado a: ${htmlEscape(ticket.assignedTo||"Sin asignar")}</div>
            <div class="meta deadline">Deadline: ${ticket.deadline ? htmlEscape(ticket.deadline) : "Sin fecha"}</div>
            <div class="inline" style="margin-top:8px"><button class="ghost" onclick="openTicketDetailModal('${ticket.id}')">Ver detalle</button><button class="urgentBtn" onclick="markUrgent('${ticket.id}')">游뚿 URGENTE</button></div>${ticket.urgentRequested?`<div class="urgentFlag">Marcado como urgente</div>`:""}
          </div>
        `
      }

      return `
        <div class="ticket">
          <h5><span class="ticketCode">${htmlEscape(ticket.id||"-")}</span>${htmlEscape(ticket.title||"-")}</h5>
          <p>${htmlEscape(ticket.description||"-")}</p>
          <div class="meta">Cliente/츼rea: ${htmlEscape(ticket.client||"-")}</div>
          <div class="meta">Prioridad: ${htmlEscape(ticket.priority||"Media")}</div>
          <div class="meta">Creado por ${htmlEscape(ticket.createdBy||"-")} 췅 ${ticket.createdAt?new Date(ticket.createdAt).toLocaleString():"-"}</div>
          <div class="meta">Asignado a: ${htmlEscape(ticket.assignedTo||"Sin asignar")}</div>
            <div class="meta deadline">Deadline: ${ticket.deadline ? htmlEscape(ticket.deadline) : "Sin fecha"}</div>
          ${renderTicketActions(ticket.id, status)}
          ${renderComments(ticket.id, ticket.comments || {})}
        </div>
      `
    }

    async function openTicketDetailModal(id){
      const ticket = cachedTickets.find(t => t.id === id)
      if(!ticket) return alert("No se encontr칩 el ticket")

      document.getElementById("ticketDetailContent").innerHTML = `
        <div class="row">
          <div><label>C칩digo</label><input value="${htmlEscape(ticket.id||"")}" disabled></div>
          <div><label>T칤tulo</label><input value="${htmlEscape(ticket.title||"")}" disabled></div>
          <div><label>Prioridad</label><input value="${htmlEscape(ticket.priority||"Media")}" disabled></div>
        </div>
        <div><label>Detalle</label><textarea disabled>${htmlEscape(ticket.description||"")}</textarea></div>
        <div><label>Cliente/츼rea</label><input value="${htmlEscape(ticket.client||"")}" disabled></div>
        <div><label>Asignado a</label><input value="${htmlEscape(ticket.assignedTo||"Sin asignar")}" disabled></div>
        <div><label>Deadline</label><input value="${htmlEscape(ticket.deadline||"")}" disabled></div>
        ${renderComments(id, ticket.comments || {})}
      `
      document.getElementById("ticketDetailModal").classList.remove("hidden")
    }

    function closeTicketDetailModal(){
      document.getElementById("ticketDetailModal").classList.add("hidden")
      document.getElementById("ticketDetailContent").innerHTML = ""
    }

    function renderTicketActions(id, currentStatus){
      const options = Object.entries(STATUS)
        .filter(([key]) => key !== currentStatus)
        .map(([key, label]) => `<option value="${key}">${label}</option>`)
        .join("")

      const canDelete = currentRole === "admin"
      const canMove = currentRole === "admin" || currentRole === "analista"
      const canAssign = currentRole === "admin" || currentRole === "analista"

      const assignSelect = canAssign ? `
        <div class="inline" style="margin-top:8px;width:100%">
          <input id="assign-${id}" placeholder="Email analista" style="margin:0;min-width:170px" />
          <button class="ghost" onclick="assignTicket('${id}')">Asignar</button>
        </div>
      ` : ""

      const moveBlock = canMove ? `
        <select id="next-${id}" style="margin:0;min-width:160px">
          ${options}
        </select>
        <button class="ghost" onclick="moveTicket('${id}')">Mover</button>
      ` : `<span class="small">Solo admin/analista pueden mover estados</span>`

      return `
        <div class="inline" style="margin-top:8px">
          ${moveBlock}
          ${canDelete?`<button class="danger" onclick="deleteTicket('${id}')">Borrar</button>`:""}
        </div>
        ${assignSelect}
      `
    }

    function renderComments(id, comments){
      const list = Object.values(comments || {}).sort((a,b)=>new Date(a.createdAt||0)-new Date(b.createdAt||0))
      return `
        <div style="margin-top:10px;border-top:1px solid rgba(148,163,184,.2);padding-top:8px">
          <div class="small" style="margin-bottom:6px">Comentarios</div>
          ${list.length ? list.map(c=>`<div class="small" style="margin-bottom:4px"><strong>${htmlEscape(c.author||"-")}</strong>: ${htmlEscape(c.message||"")} <span style="opacity:.8">(${c.createdAt?new Date(c.createdAt).toLocaleString():""})</span></div>`).join("") : `<div class="small">Sin comentarios</div>`}
          <div class="inline" style="margin-top:6px">
            <input id="comment-${id}" placeholder="Escrib칤 un comentario" style="margin:0" />
            <button class="ghost" onclick="addComment('${id}')">Comentar</button>
          </div>
        </div>
      `
    }

    async function markUrgent(id){
      const ticket = cachedTickets.find(t => t.id === id)
      if(!ticket) return
      const updated = { ...ticket, urgentRequested: true, updatedAt: new Date().toISOString(), updatedBy: currentUser.email }
      showToast("Marcando urgente...", "info", 1400)
      await db.ref("tickets").child(id).update(updated)
      mirrorToSheet("updateTicket", { id, ...updated })
      const ix = cachedTickets.findIndex(t => t.id === id)
      if(ix >= 0) cachedTickets[ix] = updated
      renderTicketsFromData(cachedTickets)
      await logActivity("ticket_urgente", { ticketId: id, title: ticket.title })
      loadDashboard()
      showToast("Ticket marcado como urgente", "ok")
    }

    async function moveTicket(id){
      if(!(currentRole === "admin" || currentRole === "analista")) return alert("No ten칠s permisos para mover tickets")
      const next = document.getElementById(`next-${id}`)?.value
      if(!next) return

      showToast("Moviendo ticket...", "info", 1600)
      const ticket = cachedTickets.find(t => t.id === id)
      if(!ticket) return
      const updated = { ...ticket, status: next, updatedAt: new Date().toISOString(), updatedBy: currentUser.email }
      await db.ref("tickets").child(id).update(updated)
      mirrorToSheet("updateTicket", { id, ...updated })
      logActivity("ticket_movido", { ticketId: id, nextStatus: next })
      loadTickets()
      await loadDashboard()
      showToast("Ticket movido correctamente", "ok")
    }

    async function assignTicket(id){
      if(!(currentRole === "admin" || currentRole === "analista")) return alert("No ten칠s permisos para asignar tickets")
      const assignedTo = (document.getElementById(`assign-${id}`)?.value || "").trim().toLowerCase()
      if(!assignedTo) return alert("Ingres치 el email del analista")

      const user = (await db.ref("users_by_email").child(emailKey(assignedTo)).once("value")).val()
      if(!user || user.role !== "analista") return alert("El usuario no existe o no es analista")

      showToast("Asignando ticket...", "info", 1600)
      const ticket = cachedTickets.find(t => t.id === id)
      if(!ticket) return
      const updated = { ...ticket, assignedTo, updatedAt: new Date().toISOString(), updatedBy: currentUser.email }
      await db.ref("tickets").child(id).update(updated)
      mirrorToSheet("updateTicket", { id, ...updated })
      logActivity("ticket_asignado", { ticketId: id, assignedTo })
      loadTickets()
      showToast("Ticket asignado correctamente", "ok")
    }

    async function addComment(id){
      const message = (document.getElementById(`comment-${id}`)?.value || "").trim()
      if(!message) return

      showToast("Enviando comentario...", "info", 1600)
      const ticket = cachedTickets.find(t => t.id === id)
      if(!ticket) return
      const comments = { ...(ticket.comments || {}) }
      comments[generateId()] = { message, author: currentUser.email, createdAt: new Date().toISOString() }
      const updated = { ...ticket, comments, updatedAt: new Date().toISOString(), updatedBy: currentUser.email }

      await db.ref("tickets").child(id).update(updated)
      mirrorToSheet("updateTicket", { id, ...updated })
      const ix = cachedTickets.findIndex(t => t.id === id)
      if(ix >= 0) cachedTickets[ix] = updated
      renderTicketsFromData(cachedTickets)
      const input = document.getElementById(`comment-${id}`)
      if(input) input.value = ""
      logActivity("ticket_comentario", { ticketId: id })
      const detailOpen = !document.getElementById("ticketDetailModal").classList.contains("hidden")
      if(detailOpen) openTicketDetailModal(id)
      loadDashboard()
      showToast("Comentario enviado correctamente", "ok")
    }

    async function deleteTicket(id){
      if(!confirm("쯉eguro que quer칠s borrar este ticket?")) return
      showToast("Eliminando ticket...", "info", 1600)
      await db.ref("tickets").child(id).remove()
      mirrorToSheet("deleteTicket", { id })
      logActivity("ticket_borrado", { ticketId: id })
      loadTickets()
      await loadDashboard()
      showToast("Ticket eliminado correctamente", "ok")
    }

    async function saveUserAccess(){
      if(currentRole !== "admin") return alert("Solo admin puede crear usuarios")
      const email = document.getElementById("uEmail").value.trim().toLowerCase()
      const password = document.getElementById("uPassword").value.trim()
      const role = document.getElementById("uRole").value
      if(!email || !password) return alert("Complet치 email y contrase침a")

      await db.ref("users_by_email").child(emailKey(email)).set({
        email, password, role, active: true,
        createdAt: new Date().toISOString(), createdBy: currentUser.email
      })
      alert("Usuario creado correctamente")
    }

    function loadUsersAdmin(){
      const container = document.getElementById("usersList")
      if(!container) return

      db.ref("users_by_email").off()
      db.ref("users_by_email").on("value", snap => {
        const items = Object.entries(snap.val() || {})
        if(!items.length){ container.innerHTML = "Sin usuarios cargados"; return }

        container.innerHTML = items.map(([k,u]) => {
          const isSelf = (u.email||"").toLowerCase() === (currentUser.email||"").toLowerCase()
          return `<div class="card" style="padding:10px;margin:6px 0"><div class="inline" style="justify-content:space-between"><div><strong>${htmlEscape(u.email||"-")}</strong><br><span class="small">Rol: ${htmlEscape(u.role||"-")} 췅 Clave: Oculta</span></div><div class="inline"><button class="danger" ${isSelf?"disabled":""} onclick="deleteUserAccess('${k}','${u.email||''}')">Eliminar</button></div></div></div>`
        }).join("")
      })
    }

    async function deleteUserAccess(key,email){
      if(currentRole !== "admin") return alert("Solo admin puede eliminar usuarios")
      if(!confirm(`쮼liminar acceso para ${email}?`)) return
      await db.ref("users_by_email").child(key).remove()
      await loadFilterOptions()
    }

    async function loadDashboard(){
      try{
        const ticketsArr = await fetchTicketsFromDb()
        const users = Object.values((await db.ref("users_by_email").once("value")).val() || {})
        const activity = Object.values((await db.ref("activity_logs").limitToLast(10).once("value")).val() || {})

        let total = 0, unassigned = 0, doing = 0, done = 0
        ticketsArr.forEach(t => {
          total++
          if(t.status === "unassigned") unassigned++
          if(t.status === "doing") doing++
          if(t.status === "done") done++
        })

        const ops = users.filter(u => u && u.role === "analista")
        const last = ops.map(u => u.lastAccessAt ? new Date(u.lastAccessAt).getTime() : 0).sort((a,b)=>b-a)[0] || 0

        document.getElementById("kpiTotal").innerText = total
        document.getElementById("kpiUnassigned").innerText = unassigned
        document.getElementById("kpiDoing").innerText = doing
        document.getElementById("kpiDone").innerText = done
        document.getElementById("kpiOperators").innerText = ops.length
        const lastAccessEl = document.getElementById("kpiLastAccess")
        if(lastAccessEl){
          lastAccessEl.innerText = last ? new Date(last).toLocaleString() : "Sin accesos"
        }

        if(currentRole === "consultor") {
          const commentsContainer = document.getElementById("consultorCommentsActivity")
          if(commentsContainer){
            const onlyMine = ticketsArr.filter(t => (t.createdBy||"") === currentUser.email)
            const roleByEmail = Object.fromEntries(users.map(u => [String(u.email||"").toLowerCase(), u.role]))
            const comments = onlyMine.flatMap(t => Object.values(t.comments||{}).map(c => ({ ticketId: t.id, ticketTitle: t.title, ...c })))
              .filter(c => { const r = roleByEmail[String(c.author||"").toLowerCase()]; return r === "admin" || r === "analista" })
              .sort((a,b)=>new Date(b.createdAt||0)-new Date(a.createdAt||0))
            commentsContainer.innerHTML = comments.length
              ? comments.map(c => `<div class="feedItem"><div class="feedType">${htmlEscape(c.author||"-")}</div><div class="feedMeta">${htmlEscape(c.message||"")}<br>(${htmlEscape(c.ticketId||"-")} 췅 ${htmlEscape(c.ticketTitle||"-")}) ${c.createdAt ? "췅 " + new Date(c.createdAt).toLocaleString() : ""}</div></div>`).join("")
              : `<p class="small">Sin comentarios a칰n.</p>`
          }
          return
        }

        const container = document.getElementById("recentActivity")
        if(!container) return
        const sorted = activity.sort((a,b)=>new Date(b.timestampIso||0)-new Date(a.timestampIso||0))
        if(!sorted.length){
          container.innerHTML = `<p class="small">Sin actividad reciente.</p>`
        }else{
          container.innerHTML = sorted.map(it => `
            <div class="feedItem">
              <div class="feedTop">
                <div>
                  <div class="feedType">${htmlEscape(it.eventType || "evento")}</div>
                  <div class="feedMeta">${htmlEscape(it.email || "sin-usuario")} 췅 ${it.timestampIso ? new Date(it.timestampIso).toLocaleString() : ""}</div>
                </div>
                <span class="badge ${it.role === "admin" ? "ok" : "off"}">${htmlEscape(it.role || "-")}</span>
              </div>
            </div>
          `).join("")
        }
      }catch(_){ }
    }

    async function ensureDefaultClients(){
      const samples = ["Cliente de prueba 1.", "Cliente de prueba 2."]
      const clients = Object.values((await db.ref("clients").once("value")).val() || {})
      for(const name of samples){
        const exists = clients.some(c => (c.name||"") === name)
        if(!exists){
          await db.ref("clients").child(emailKey(name)).set({ name, createdAt: new Date().toISOString(), createdBy: "system" })
          mirrorToSheet("upsertClient", { key: emailKey(name), name, createdAt: new Date().toISOString(), createdBy: "system" })
        }
      }
    }

    async function init(){
      try{
        renderLogin()
        await ensureDefaultUsers()
        await ensureDefaultClients()
      }catch(err){
        console.error("Error en inicializaci칩n:", err)
        renderLogin()
        showToast("La app inici칩 con advertencias. Revis치 la consola.", "error", 3000)
      }
    }

    init()
  </script>
</body>
</html>
